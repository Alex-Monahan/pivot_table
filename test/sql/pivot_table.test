# name: test/sql/pivot_table.test
# description: test pivot_table extension
# group: [pivot_table]

statement ok
PRAGMA enable_verification;

# Before we load the extension, this will fail
statement error
SELECT pivot_table('Sam');
----
Catalog Error: Scalar Function with name pivot_table does not exist!

# Require statement will ensure this test is run with this extension loaded
require pivot_table

# Confirm the extension works
statement ok
CREATE OR REPLACE TABLE my_table AS 
    SELECT x % 11 AS col1, x % 5 AS col2, x % 2 AS col3, 1 AS col4
    FROM range(1,101) t(x)
;

statement ok
CREATE OR REPLACE TABLE my_table_with_nulls AS
    FROM my_table
    UNION ALL SELECT NULL, 0, 0, 0
    UNION ALL SELECT 0, NULL, 0, 0
    UNION ALL SELECT 0, 0, NULL, 0
    UNION ALL SELECT 0, 0, 0, NULL
;

statement ok
CREATE OR REPLACE TABLE cursed_column_names("Country Name" VARCHAR, "City's Name" VARCHAR, "The ""'Year'""" INT, "Approx. ""Population""" FLOAT);

statement ok
INSERT INTO cursed_column_names VALUES ('NL', 'Amsterdam', 2000, 1005);

statement ok
INSERT INTO cursed_column_names VALUES ('NL', 'Amsterdam', 2010, 1065);

statement ok
INSERT INTO cursed_column_names VALUES ('NL', 'Amsterdam', 2020, 1158);

statement ok
INSERT INTO cursed_column_names VALUES ('US', 'Seattle', 2000, 564);

statement ok
INSERT INTO cursed_column_names VALUES ('US', 'Seattle', 2010, 608);

statement ok
INSERT INTO cursed_column_names VALUES ('US', 'Seattle', 2020, 738);

statement ok
INSERT INTO cursed_column_names VALUES ('US', 'New York City', 2000, 8015);

statement ok
INSERT INTO cursed_column_names VALUES ('US', 'New York City', 2010, 8175);

statement ok
INSERT INTO cursed_column_names VALUES ('US', 'New York City', 2020, 8772);

statement ok
INSERT INTO cursed_column_names VALUES ('Across the "''world''"', ' "Funky''s town" ', 2000, 0);

statement ok
INSERT INTO cursed_column_names VALUES ('Across the "''world''"', ' "Funky''s town" ', 2010, -1);

statement ok
INSERT INTO cursed_column_names VALUES ('Across the "''world''"', ' "Funky''s town" ', 2020, -2);

query I
FROM pivot_table(['my_table'],[], ['col3'], [], []);
----
0
1

statement error
FROM pivot_table(['zzzzz'],[], ['col3'], [], []);
----
Catalog Error: Table with name zzzzz does not exist!

# Validate that the most complex query will run across all combinations of values_axis, subtotals, and grand_totals
foreach values_axis rows columns

loop subtotals 0 1

loop grand_totals 0 1

# skipif and onlyif evaluate each expression separately, not in combination with one another. 
# (So I can't exclude invalid pivot table parameter combinations)
# As a result, I will just use this for the values_axis, subtotals, and grand_totals parameters

statement ok
FROM pivot_table(['my_table', 'my_table_with_nulls'], ['sum(col1)', 'sum(col2)'], ['col3', 'col4'], [], ['col3 = 0', 'col3 = 0+0'], values_axis:='${values_axis}', subtotals:=${subtotals}, grand_totals:=${grand_totals});

endloop

endloop

endloop

